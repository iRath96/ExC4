<!DOCTYPE html>
<html>
  <head>
    <title>ExChillusion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">
    
    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/knockout-3.1.0.js"></script>
    <script type="text/javascript" src="js/knockout.validation.js"></script>
    <script type="text/javascript" src="js/sprite.js"></script>
    
    <script type="text/javascript" src="node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
    <script type="text/javascript" src="main.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    
    <script type="text/javascript" src="js/client.js"></script>
    <script type="text/javascript" src="js/client/channel.js"></script>
    <script type="text/javascript" src="js/client/channel-storage.js"></script>
    <script type="text/javascript" src="js/client/participant.js"></script>
    
    <script type="text/javascript" src="js/host.js"></script>
    <script type="text/javascript" src="js/host/channel.js"></script>
    <script type="text/javascript" src="js/host/channel-storage.js"></script>
    <script type="text/javascript" src="js/host/participant.js"></script>
    <script type="text/javascript" src="js/host/session.js"></script>
    
    <script type="text/javascript">
      
      // TODO:2014-08-17:alex:Notification center
      // TODO:2014-08-17:alex:Stats from plugins
      // TODO:2014-08-17:alex:Cache package.json for plugins
      // TODO:2014-08-17:alex:Profile screen
      // TODO:2014-08-17:alex:Validation isn't working anymore.
      // TODO:2014-08-17:alex:ExHost not working in ExCloud.
      // TODO:2014-08-17:alex:Enter for form fields.
      // TODO:2014-08-21:alex:A watch2gether plugin.
      // TODO:2014-08-23:alex:A pool plugin, polls in chat4, a whiteboard plugin, a collaborative writing plugin.
      // TODO:2014-08-23:alex:Delta-updates for objects in channelData and userData (split by dots).
      
      jQuery.fn.center = function () {
        this.css("position","absolute");
        this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) +
                                 $(window).scrollTop()) + "px");
        this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) +
                                  $(window).scrollLeft()) + "px");
        return this;
      }; // Required because of issues with newer versions of jQuery UI
      
      var viewModel = {
        username : ko.observable('alex').extend({ minLength:3 }),
        password : ko.observable('test').extend({ minLength:4 }),
        host     : ko.observable('http://cappucci.noip.me:8042/').extend({ required:true })
      };
      
      var debugClient;
      $(window).unload(function() {
        if(debugClient) debugClient.logout();
      });
      
      $(document).ready(function() {
        ko.validation.configure({
          decorateElement: true,
          errorElementClass: 'error',
        });
        
        viewModel.errors = ko.validation.group(viewModel);
        ko.applyBindings(viewModel);
        
        $('#plugin_alert img.icon').load(function() {
          $(this).show(); // TODO:2014-08-25:alex:This should be in a class together with showPluginAlert.
        });
        
        var pendingUId = null;
        $('#trust_btn').click(function() {
          $('#plugin_alert').dialog('close');
          debugClient.joinUId(pendingUId);
        });
        
        $('#distrust_btn').click(function() {
          $('#plugin_alert').dialog('close');
        });
        
        $('#loading').hide().css('opacity', 0.0);
        
        var dancer = new Sprite('anim/dancing_anim@2x.png').setFPS(15);
        $('#about_page').append('<br />').append(dancer.element).append('<br />');
        
        $('.page').css('left', '100%').each(function(i, a) {
          $('#' + a.id.replace('_page', '_btn')).click(function() {
            $('#select').animate({ left: '-100%' });
            $('#' + a.id).animate({ left: 0 });
          });
          
          var backBtn = document.createElement('span');
          backBtn.style.marginTop = '20px';
          backBtn.className = 'button';
          backBtn.innerHTML = '&laquo; ' + (a.id == 'loggedin_page' ? 'logout' : 'back');
          backBtn.onclick = function() {
            if(a.id == 'loggedin_page') debugClient.logout(); // TODO: Ouch!
            $('#' + a.id).animate({ left: '100%' });
            $('#select').animate({ left: 0 });
          };
          
          if(a.id != 'host_page') $('#' + a.id).append(backBtn);
        });
        
        $('#host_btn').click(function(e) {
          new ExHost(8042);
        });
        
        $('#login_btn,#register_btn').click(function(e) {
          for(var k in viewModel) // revalidate everything
            if(viewModel[k].__valid__ !== undefined)
              ko.validation.validateObservable(viewModel[k]);
          
          if(viewModel.errors().length > 0) {
            $('#join_page').effect('shake');
            viewModel.errors.showAllMessages(true);
            return;
          }
          
          var register = e.target.id == 'register_btn';
          
          $('#join_page input.error').removeClass('error');
          $('.error').hide();
          
          setLoading('#join_page', 'Connecting to server', 'tumbleweed');
          
          // Connect...
          
          var c = debugClient = new ExClient(viewModel.host());
          c.socket.on('connect', function() {
            setLoadingMessage(register ? 'Registering' : 'Logging in');
            c[register ? 'register' : 'authenticate'](viewModel.username(), viewModel.password());
          });
          
          c.socket.on('connect_error', function(e) {
            viewModel.host.error('Coult not connect: ' + e);
            viewModel.host.__valid__(false);
            
            hideLoader('#join_page');
          });
          
          function joinError(register) {
            var errorset = register ? { // TODO: Localize! Hooray!
              username: 'The username exists already.',
              password: 'The password is horrible, we were able to bruteforce it.'
            } : {
              username: 'The username does not exist. Is your keyboard broken?',
              password: 'The password does not exist. Is your keyboard broken?'
            };
            
            return function(field) {
              viewModel[field].error(errorset[field]);
              viewModel[field].__valid__(false);
              
              hideLoader('#join_page');
            };
          }
          
          c.socket.on('session-error', joinError(false));
          c.socket.on('register-error', joinError(true));
          
          c.socket.on('list', function(list) {
            listChannels(list); // TODO: Integrate the function into this callback.
          });
          
          c.socket.on('login', function() {
            setLoading('#join_page', 'Congratulations', 'nod', 10);
            hideLoader();
            
            $('#loggedin_page').css('opacity', 0.0).css('left', 0).animate({
              opacity: 1.0
            });
            
            $('#beta_btn').click(function(e) {
              var feature = prompt(
                "This is the beta-feature section for features that have\n" +
                "no GUI yet and are likely to change a lot in upcoming\n" +
                "releases. Please enter the code-phrase below.\n" +
                "* p2p  * nickname  * picture  * preference  * clear-cache"
              );
              if(feature === null) return;
              
              switch(feature.toLowerCase()) {
                case 'preference': {
                  var key = prompt(
                    "Preference key?\n" +
                    "* notifyVisual - value either false or true\n" +
                    "* notifySound - value either an URL in quotation marks or \"\" for no sound"
                  );
                  if(key === null) return;
                  var current = JSON.stringify(debugClient.preferences[key]);
                  var value = prompt('New value? Current value is listed as default.', current);
                  if(value !== null) debugClient.setPreference(key, JSON.parse(value));
                }; break;
                case 'p2p': {
                  var peer = prompt('Username of other peer?');
                  if(peer !== null) debugClient.requestP2P(peer);
                }; break;
                case 'nickname': {
                  var nickname = prompt('Your new nickname?');
                  if(nickname !== null) debugClient.socket.emit('profile', 'nickname', nickname);
                }; break;
                case 'picture': {
                  var picture = prompt("Your avatar as 64x64 image/jpeg 0.85 base64-URL?\n" +
                                       "If that confuses you, copy the code from\n" +
                                       "http://cappucci.noip.me/agen");
                  if(picture !== null) debugClient.socket.emit('profile', 'picture', picture);
                }; break;
                case 'clear-cache': {
                  require('nw.gui').App.clearCache(); // for node-webkit
                  alert("Your cache has been cleared.");
                }; break;
              }
            });
            
            $('#list_btn').click(function(e) {
              c.socket.emit('list');
            });
            
            $('#channel_btn').click(function(e) {
              var cname = prompt('Which channel do you want to join?', 'bj');
              if(cname === null) return;
              
              c.probe(cname, function(o) {
                if(o.success) {
                  pendingUId = o.summary.uid;
                  showPluginAlert(o.summary.plugin);
                  /*if(confirm(
                    'The channel ' + cname + ' uses the plugin ' + o.summary.plugin + ".\n" +
                    'Do you trust this plugin?'
                  )) c.joinUId(o.summary.uid); // Channel exists*/
                } else {
                  var plugin = prompt('The channel does not exist. Type a plugin-URL to create it.', 'plugins/blackjack');
                  if(plugin !== null) c.create(cname, plugin); // Channel does not exist
                }
              });
            });
          });
        });
      });
      
      function showPluginAlert(plugin) {
        $('#plugin_alert span.url').text(plugin);
        $('#plugin_alert').addClass('loading');
        $('#plugin_alert').dialog({ title:'Plugin trust', width:400, modal:true });
        
        $.getJSON(plugin + '/package/package.json', function(d) {
          $('#plugin_alert img.icon')[0].src = plugin + '/' + d.icon;
          $('#plugin_alert img.icon').hide();
          
          $('#plugin_alert span.title').text(d.name);
          $('#plugin_alert span.author').text('by ' + d.author);
          $('#plugin_alert span.description').text(d.description);
          
          setTimeout(function() {
            $('#plugin_alert').parent().center();
          }, 0); // Sometimes the DOM is weird. TODO: Required?
          $('#plugin_alert').removeClass('loading');
        });
      }
      
      function listChannels(list) {
        function __(tag, klass, text) {
          var e = document.createElement(tag);
          e.className = klass;
          e.textContent = text;
          return e;
        }
        
        var cl = $('#channel_list');
        //cl.html(list.length == 0 ? "You are... FOREVER ALONE!<br />Talking to ARI might cheer you up." : '');
        cl.text('');
        
        for(var i = 0; i < list.length; ++i) {
          var chan = list[i];
          var div = __('div', 'channel', '');
          
          div.appendChild(__('span', 'title', chan.name));
          div.appendChild(__('span', 'host', 'by ' + chan.host));
          div.appendChild(__('span', 'count', chan.count.join(' / ')));
          div.appendChild(__('br', '', ''));
          div.appendChild(__('span', 'motd', chan.motd));
          $(div).dblclick(function(uid) { return function() {
            debugClient.joinUId(uid);
          }; }(chan.uid));
          
          cl.append(div);
        }
      }
      
      function setLoading(sender, message, emoticon, fps) {
        setLoadingMessage(message);
        setLoadingEmoticon(emoticon, fps);
        showLoader(sender);
      }
      
      var loaderShown = false;
      function showLoader(sender) {
        if(loaderShown) return;
        
        if(sender) $(sender).stop().animate({ opacity: 0.0 }, { complete: function() { $(sender).hide(); }});
        $('#loading').stop().show().animate({ opacity: 1.0 });
        
        loaderShown = true;
      }
      
      function hideLoader(sender) {
        if(!loaderShown) return;
        
        if(sender) $(sender).stop().show().animate({ opacity: 1.0 });
        $('#loading').stop().animate({ opacity: 0.0 }, { complete: function() { $('#loading').hide(); }});
        
        loaderShown = false;
      }
      
      function setLoadingMessage(message) {
        $('#loading .status').text(message);
      }
      
      var loadingEmote;
      function setLoadingEmoticon(name, fps) {
        if(loadingEmote) loadingEmote.stop();
        if(fps === undefined) fps = 15;
        
        loadingEmote = new Sprite('anim/' + name + '_anim@2x.png').setFPS(fps);
        $('#loading div').replaceWith(loadingEmote.element);
      }
      
    </script>
  </head>
  <body>
    <div id="plugin_alert" style="padding-left:90px;min-height:68px;display:none;">
      <img class="icon" width="64" height="64" style="position:absolute;left:10px;" />
      <span class="url">http://cappucci.noim.me/plugins/chat4</span><br />
      <span class="loader">Loading</span>
      <span class="title">Chat Plugin</span><span class="author">by Alexander Rath</span><br />
      <span class="description">Description here</span><br />
      <br />
      <span class="actions" style="float:right;">
        <input id="trust_btn" class="small" type="button" value="Trust" />
        <input id="distrust_btn" class="small" type="button" value="Distrust" />
      </span><br style="clear:both;" />
    </div>
    <div id="select" class="uibox" style="white-space:normal;">
      <h1>ExChillusion</h1>
      <input id="join_btn" type="button" value="Join a network" /><br />
      <input id="host_btn" type="button" value="Host a network" /><br />
      <input id="about_btn" type="button" value="About" />
    </div>
    <div id="join_page" class="uibox page">
      <input data-bind="value:host" id="host" type="text" placeholder="Host" /><br />
      <input data-bind="value:username" id="username" type="text" placeholder="Username" /><br />
      <input data-bind="value:password" id="password" type="password" placeholder="I can haz passwd?" /><br />
      <input id="login_btn" type="button" value="Login" style="margin-top:20px;width:158px;" />
      <input id="register_btn" type="button" value="Register" style="margin-top:20px;width:158px;" />
      <br />
    </div>
    <div id="host_page" class="uibox page"><input type="button" value="Hosting on 8042" />
      <pre class="debug">Running on port 8042</pre>
    </div>
    <div id="about_page" class="uibox page">
      Yes, we're <b>awesome</b>. We created this awesome application for you.
      Thank us. Praise us.
      
      Don't listen to what the NSA tells you.
      <em>We're</em> America's real codebreakers. And it's a lot of fun.
    </div>
    <div id="loggedin_page" class="uibox page" style="white-space:normal;">
      <div id="channel_list" class="debug" style="height:160px;">(Will list channels for money)</div><br />
      <input id="channel_btn" type="button" value="Join a channel" /><br />
      <input id="list_btn" type="button" value="List channels" /><br />
      <input id="beta_btn" type="button" value="Beta features" /><br />
    </div>
    <div id="loading" class="uibox" style="padding-top:80px;">
      <!--<img src="images/spinner.gif" width="75" />-->
      <br /><div></div><span class="status"><!-- Loading message --></span>
    </div>
    <footer>
      <span>&copy; ExChillusion</span> <span style="opacity:0.7;">&mdash; We own your soul.</span>
    </footer>
  </body>
</html>