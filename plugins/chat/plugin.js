var smileys = [];
smileys[']:)'] = 'emoticon-0116-evilgrin';
smileys['&gt;:)'] = 'emoticon-0116-evilgrin';
smileys['(grin)'] = 'emoticon-0116-evilgrin';
smileys[':)'] = 'emoticon-0100-smile';
smileys[':('] = 'emoticon-0101-sadsmile';
smileys[':D'] = 'emoticon-0102-bigsmile';
smileys['8-)'] = 'emoticon-0103-cool';
smileys[':o'] = 'emoticon-0104-surprised';
smileys[':O'] = 'emoticon-0104-surprised';
smileys[';)'] = 'emoticon-0105-wink';
smileys[';('] = 'emoticon-0106-crying';
smileys[':\'('] = 'emoticon-0106-crying';
smileys['(sweat)'] = 'emoticon-0107-sweating';
smileys[':|'] = 'emoticon-0108-speechless';
smileys['(lorenzo)'] = 'emoticon-0108-speechless';
smileys[':*'] = 'emoticon-0109-kiss';
smileys[':P'] = 'emoticon-0110-tongueout';
smileys[':$'] = 'emoticon-0111-blush';
smileys['(blush)'] = 'emoticon-0111-blush';
smileys[':^)'] = 'emoticon-0112-wondering';
smileys['|-)'] = 'emoticon-0113-sleepy';
smileys['|-('] = 'emoticon-0114-dull';
smileys['(involve)'] = 'emoticon-0115-inlove';
smileys['(talk)'] = 'emoticon-0117-talking';
smileys['(yawn)'] = 'emoticon-0118-yawn';
smileys['(puke)'] = 'emoticon-0119-puke';
smileys['(doh)'] = 'emoticon-0120-doh';
smileys['&gt;.&lt;'] = 'emoticon-0120-doh';
smileys[':@'] = 'emoticon-0121-angry';
smileys['(wasntme)'] = 'emoticon-0122-itwasntme';
smileys['(party)'] = 'emoticon-0123-party';
smileys[':s'] = 'emoticon-0124-worried';
smileys[':S'] = 'emoticon-0124-worried';
smileys['(mm)'] = 'emoticon-0125-mmm';
smileys['(nerd)'] = 'emoticon-0126-nerd';
smileys['(paul1)'] = 'emoticon-0126-nerd';
smileys[':x'] = 'emoticon-0127-lipssealed';
smileys[':X'] = 'emoticon-0127-lipssealed';
smileys['(wave)'] = 'emoticon-0128-hi';
smileys['(call)'] = 'emoticon-0129-call';
smileys['(devil)'] = 'emoticon-0130-devil';
smileys['(angle)'] = 'emoticon-0131-angel';
smileys['(envy)'] = 'emoticon-0132-envy';
smileys['(wait)'] = 'emoticon-0133-wait';
smileys['(bear)'] = 'emoticon-0134-bear';
smileys['(pedobear)'] = 'emoticon-0134-bear';
smileys['(makeup)'] = 'emoticon-0135-makeup';
smileys['(giggle)'] = 'emoticon-0136-giggle';
smileys['(chuckle)'] = 'emoticon-0136-giggle';
smileys['(clap)'] = 'emoticon-0137-clapping';
smileys['(think)'] = 'emoticon-0138-thinking';
smileys[':?'] = 'emoticon-0138-thinking';
smileys['(bow)'] = 'emoticon-0139-bow';
smileys['(paul2)'] = 'emoticon-0130-devil';
smileys['(rofl)'] = 'emoticon-0140-rofl';
smileys['(whew)'] = 'emoticon-0141-whew';
smileys['(gay)'] = 'emoticon-0142-happy';
smileys['(happy)'] = 'emoticon-0142-happy';
smileys['(smirk)'] = 'emoticon-0143-smirk';
smileys['(nod)'] = 'emoticon-0144-nod';
smileys['(shake)'] = 'emoticon-0145-shake';
smileys['(punch)'] = 'emoticon-0146-punch';
smileys['(emo)'] = 'emoticon-0147-emo';
smileys['(paul3)'] = 'emoticon-0147-emo';
smileys['(y)'] = 'emoticon-0148-yes';
smileys['(yes)'] = 'emoticon-0148-yes';
smileys['(n)'] = 'emoticon-0149-no';
smileys['(no)'] = 'emoticon-0149-no';
smileys['(handshake)'] = 'emoticon-0150-handshake';
//smileys['(skype)'] = 'emoticon-0151-skype';
smileys['(heart)'] = 'emoticon-0152-heart';
smileys['<3'] = 'emoticon-0152-heart';
smileys['(u)'] = 'emoticon-0153-brokenheart';
smileys['</3'] = 'emoticon-0153-brokenheart';
smileys['<\\3'] = 'emoticon-0153-brokenheart';
smileys['(mail)'] = 'emoticon-0154-mail';
smileys['(flower)'] = 'emoticon-0155-flower';
smileys['(rain)'] = 'emoticon-0156-rain';
smileys['(sun)'] = 'emoticon-0157-sun';
smileys['(time)'] = 'emoticon-0158-time';
smileys['(music)'] = 'emoticon-0159-music';
smileys['(movie)'] = 'emoticon-0160-movie';
smileys['(phone)'] = 'emoticon-0161-phone';
smileys['(coffee)'] = 'emoticon-0162-coffee';
smileys['(pi)'] = 'emoticon-0163-pizza';
smileys['(pizza)'] = 'emoticon-0163-pizza';
smileys['(cash)'] = 'emoticon-0164-cash';
smileys['(muscle)'] = 'emoticon-0165-muscle';
smileys['(cake)'] = 'emoticon-0166-cake';
smileys['(beer)'] = 'emoticon-0167-beer';
smileys['(drink)'] = 'emoticon-0168-drink';
smileys['(dance)'] = 'emoticon-0169-dance';
smileys['(shuffle)'] = 'emoticon-0169-dance';
smileys['(ninja)'] = 'emoticon-0170-ninja';
smileys['(alex)'] = 'emoticon-0189-priidu';
smileys['(star)'] = 'emoticon-0171-star';
smileys['(mooning)'] = 'emoticon-0172-mooning';
smileys['(moon)'] = 'emoticon-0172-mooning';
smileys['(fu)'] = 'emoticon-0173-middlefinger';
smileys['(bandit)'] = 'emoticon-0174-bandit';
smileys['(paul4)'] = 'emoticon-0174-bandit';
smileys['(drunk)'] = 'emoticon-0175-drunk';
smileys['(paul5)'] = 'emoticon-0175-drunk';
smileys['(smoke)'] = 'emoticon-0176-smoke';
smileys['(toivo)'] = 'emoticon-0177-toivo';
smileys['(rock)'] = 'emoticon-0178-rock';
smileys['(headbang)'] = 'emoticon-0179-headbang';
smileys['(hb)'] = 'emoticon-0179-headbang';
smileys['(bug)'] = 'emoticon-0180-bug';
smileys['(feature)'] = 'emoticon-0180-bug';
smileys['(fubar)'] = 'emoticon-0181-fubar';
smileys['(poolparty)'] = 'emoticon-0182-poolparty';
smileys['(pp)'] = 'emoticon-0182-poolparty';
smileys['(swear)'] = 'emoticon-0183-swear';
smileys['&gt;:$'] = 'emoticon-0183-swear';
smileys['(tmi)'] = 'emoticon-0184-tmi';
smileys['(heidy)'] = 'emoticon-0185-heidy';
smileys['(myspace)'] = 'emoticon-0186-myspace';
smileys['(malthe)'] = 'emoticon-0187-malthe';
smileys['(tauri)'] = 'emoticon-0188-tauri';
smileys['(priidu)'] = 'emoticon-0189-priidu';

var satisfyPaul = [];
satisfyPaul["paul"] = "Paul";
satisfyPaul["alex"] = "Alex | The original";
satisfyPaul["lorenzo.rota"] = "Lorenzo";
satisfyPaul["irath96"] = "iRath96";

var fileCount = 1;
var transfers = [];

var CHUNK_SIZE = 65536; // 64KiB / 6 * 8 + 2B is a little much per packet (beside the meta overhead) ...

function Transfer(data, handle) {
  this.sTime = new Date().getTime();
  
  this.id = data.shift();
  this.type = data.shift();
  this.name = data.shift();
  this.size = data.shift();
  this.cSize = data.shift(); // Chunk Size //
  this.handle = handle;
  
  this.chunks = [];
  this.onfinish = function() {};
  
  this.message = addMessage(this.handle + " <i>Sending</i>", getTimeString(), "0%");
}

Transfer.prototype.handleChunk = function(data) {
  data.shift(); // We know our Id...
  this.chunks[data[0]] = data[1];
  
  var b = this.chunks.length * this.cSize;
  var p = Math.min(b / this.size, 1);
  var percent = Math.round(p * 1000) / 10 + "%";
  var bps = b / (new Date().getTime() - this.sTime);
  this.message.innerHTML = percent + " (" + byte(b) + " / " + byte(this.size) + " - " + byte(bps) + "/s)";
  
  if(this.chunks.length * this.cSize >= this.size) this.onfinish(this);
};

function byte(bytes) {
  var m = ["B", "KiB", "MiB", "GiB", "TiB"];
  var mi = 0;
  while(bytes > 1024) {
    bytes /= 1024;
    ++mi;
    if(mi == m.length) break;
  }
  
  return Math.round(bytes * 10) / 10 + m[mi];
}

var input;
function init() {
  input = document.getElementById("msgField");
  input.ondrop = function(e) {
    this.className = '';
    e.preventDefault();
    
    var file = e.dataTransfer.files[0],
        reader = new FileReader();
    
    ExAPI.sendMessage(EncStr(["file", "init", fileCount, file.type, file.fileName, file.fileSize, CHUNK_SIZE]));
    
    reader.onload = function(evt) {
      var n = evt.target;
      var len = n.result.length;
      for(var chunk = 0; chunk < len; chunk += CHUNK_SIZE)
       ExAPI.sendMessage(EncStr(["file", "chunk", fileCount, chunk / CHUNK_SIZE, n.result.substring(chunk, chunk + CHUNK_SIZE)]));
      ++fileCount;
    };
    
    reader.readAsBinaryString(file);
    return false;
  };
  
  input.ondragend = function() { this.className = ''; return false; }; // Does not work ?!
  input.ondragover = function() { this.className = 'hover'; return false; };
  
  input.onkeypress = checkForEnter;
  
  ExAPI.init();
  
  var updateUsers = function() {
    var e = document.getElementById('users');
    e.innerHTML = "<b>Users:</b> ";
    
    var spans = [];
    for(var i = 0; i < ExAPI.channel.participants.length; ++i) {
      var u = ExAPI.channel.participants[i].username;
      var span = "<span class=\"" + "user" + "\">"; // ExAPI.users[i].toLowerCase()
      span += satisfyPaul[u] ? satisfyPaul[u] : u;
      span += "</span>";
      
      spans.push(span);
    } e.innerHTML += spans.join(", ");
  };
  
  var keyChange = function(evt) {
    if(evt.username === undefined) evt.username = '(host)';
    addMessage("System", getTimeString(), "<b>" + evt.username + "</b> set the " + evt.key + " to \"" + convertMessage(evt.value).substring(1) + "\"");
  };
  
  ExAPI.on('configure', function(evt) {
    ExAPI.grid('channelGrid', {
      topic : { important:true  , write:EXROLE_USER, read:EXROLE_ANYBODY },
      king  : { important:true  , write:EXROLE_HOST, read:EXROLE_ANYBODY },
      motd  : { important:false , write:EXROLE_HOST, read:EXROLE_ANYBODY },
      icon  : { important:false , write:EXROLE_HOST, read:EXROLE_ANYBODY }
    });
    
    ExAPI.data('topic', 'No topic set.');
    ExAPI.data('motd', 'Corona: This is the message of the day, the day, the day!');
    
    ExAPI.options({
      public   : true,
      maxUsers : 150,
      commands : {
        chat : EXROLE_USER,
        me   : EXROLE_USER
      }
    });
  });
  
  ExAPI.on('error', function(evt) {
    addMessage('Error', getTimeString(), evt.error);
  });
  
  ExAPI.on('focus', function(evt) {
    if(evt.focus) ExAPI.dirty(false);
  });
  
  ExAPI.on('data', function(evt) {
    keyChange(evt);
  });
  
  ExAPI.on("init", function(evt) {
    var m = addMessage("System", getTimeString(), "Welcome to #" + ExAPI.channel.name);
    for(var k in ExAPI.channel.data)
      if(ExAPI.channel.data.hasOwnProperty(k))
        keyChange({ 'key':k, 'value':ExAPI.channel.data[k] });
    updateUsers();
  });
  
  ExAPI.on("join", function(evt) {
    addMessage("System", getTimeString(), "<b>" + evt.username + "</b> has joined the room");
    updateUsers();
  });
  
  ExAPI.on("leave", function(evt) {
    addMessage("System", getTimeString(), "<b>" + evt.username + "</b> has left the room");
    updateUsers();
  });
  
  // ExAPI.addListener("key", keyChange);
  
  ExAPI.on("push", function(evt) {
    var data = evt.data.text;
    var type = evt.data.cmd;
    
    var participant = {};
    for(var i = 0; i < ExAPI.channel.participants.length; ++i)
      if(ExAPI.channel.participants[i].username == evt.username)
        participant = ExAPI.channel.participants[i];
    
    if(type == "chat" || type == "me") {
      if(!ExAPI.hasFocus) ExAPI.dirty();
      var m = convertMessage(data);
      addMessage(evt.username, getTimeString(), m.substring(1) + "&nbsp;", type == "me", participant);
      
      //<img src="http://4.bp.blogspot.com/_7UHICy8Etfo/S-RBByuucrI/AAAAAAAAJ2Y/FS-HEPCLNVw/s1600/HungryCaterpillar.JPG">
    } else if(type == "file") {
      var subcom = data.shift().toLowerCase();
      switch(subcom) {
        case "init": {
          if(!transfers[evt.handle]) transfers[evt.handle] = [];
          var t = transfers[evt.handle][data[0]] = new Transfer(data, evt.handle);
          t.onfinish = function(ft) {
          //alert(ft.chunks.join(""));
            var id = evt.handle + '@' + ft.id;
            var data = ft.chunks.join("");
            ft.message.innerHTML = '<img id="' + id + '" class=\"unzoom\" onclick=\"zoom(this, event);\" />';
            document.getElementById(id).src = "data:" + "image/jpeg" + ";base64," + btoa(data);
          };
        }; break;
        
        case "chunk": {
          transfers[evt.handle][data[0]].handleChunk(data);
        }; break;
      }
      
      return;
      
      if(!fileTransfers[evt.handle]) {
        fileTransfers[evt.handle] = [];
        fileMessages[evt.handle] = [];
        fileMeta[evt.handle] = [];
      }
      
      if(!fileTransfers[evt.handle][data[0]]) {
        fileTransfers[evt.handle][data[0]] = [];
        fileMessages[evt.handle][data[0]] = addMessage(evt.username + " <i>Sending</i>", getTimeString(), "0%");
        fileMeta[evt.handle][data[0]] = [];
      }
      
      if(data[1] == "init") {
        var id = data[0];
        data.shift();
        data.shift();
        fileMeta[evt.handle][id] = [];
        return;
      }
      
      var ft = fileTransfers[evt.handle][data[0]];
      var fm = fileMessages[evt.handle][data[0]];
      ft[data[1]] = data[3];
      
      fm.innerHTML = Math.round((data[1] + 1) / Math.ceil(data[2] / CHUNK_SIZE) * 1000) / 10 + "% (" + (ft.length * CHUNK_SIZE) + ")";
      
      if(ft.length * CHUNK_SIZE > data[2]) {
        var id = evt.handle + '@' + data[0];
        var data = ft.join("");
        fm.innerHTML = '<img id="' + id + '" class=\"unzoom\" onclick=\"zoom(this, event);\" />';
        document.getElementById(id).src = "data:" + "image/jpeg" + ";base64," + btoa(data);
      }
    }
  });
}

var lastHandle = "";
var first = true;

function smileyTitle(smiley) {
  return smiley.split("&gt;").join(">").split("&lt;").join("<").split("&amp;").join("&");
}

function convertMessage(original) {
  var m = " " + original.split('&').join('&amp;').split('<').join('&lt;').split('>').join('&gt;');
  
  m = m.replace(/#([^ ']+)/, "<a href=\"#\" onclick=\"ExAPI.join('$1');\" title=\"Join '$1'\">#$1</a>");
  
  for(var i in smileys) m = m.split(i).join('<img src="emoticons/' + smileys[i] + '.gif" title=\"' + encode(smileyTitle(i)) + '\" />');
  m = m.replace(/\(flag:(\w\w)\)/, function(x, flag) {
    flag = flag.toLowerCase();
    var x = (flag.charCodeAt(0) - 96) * 16;
    var y = (flag.charCodeAt(1) - 96) * 11;
    var style = "background-position:-" + x + "px -" + y + "px";
    return "<div class=\"flag\" title=\"" + encode("(flag:" + flag + ")") + "\" style=\"" + style + "\"></div>";
  });
  
  m = m.replace(/\[img src="([^"]+)"\]|\[img\]([^\]]+)\[\/img\]/ig, "<img src=\"$1$2\" class=\"unzoom\" onclick=\"zoom(this, event);\" />");
  
  m = m.replace(/\[nbsp\]/ig, "&nbsp;");
  m = m.replace(/\[br\]/ig, "<br />");
  
  m = m.replace(/\[b\](.*?)\[\/b\]/ig, "<b>$1</b>");
  m = m.replace(/\[u\](.*?)\[\/u\]/ig, "<u>$1</u>");
  m = m.replace(/\[i\](.*?)\[\/i\]/ig, "<i>$1</i>");
  
  m = m.replace(/\[ul\](.*?)\[\/ul\]/ig, "<ul>$1</ul>");
  m = m.replace(/\[li\](.*?)\[\/li\]/ig, "<li>$1</li>");
  
  m = m.replace(/\[font((\s+[^=]+="[^"]+")*)\](.+)\[\/font\]/ig, function(all, params, x, content) {
    params = params.replace(/\s+([^=]+)="([^"]+)"/ig, function(all, key, value) {
      if(key == "face" || key == "size" || key == "color") return " " + key + "=\"" + value + "\"";
      return "";
    });
    return "<font" + params + ">" + content + "</font>";
  });
  
  m = m.replace(/([^"])http:\/\/([^ ]+)/ig, "$1<a target=\"blank\" href=\"http://$2\">http://$2</a>");
  return m.replace(/([^\/])www.([^ ]+)/ig, "$1<a target=\"blank\" href=\"http://www.$2\">www.$2</a>");//.substring(1);
}

function addMessage(handleText, dateText, messageText, nobr, participant) {
  ExAPI.blink();
  
  var same = lastHandle == handleText;
  lastHandle = handleText;
  
  var message = document.createElement("div");
  message.className = same ? "message" : "split message";
  
  if(!same || nobr) {
    var handle = document.createElement("span");
    handle.className = "handle";
    handle.innerHTML = (satisfyPaul[handleText] ? satisfyPaul[handleText] : handleText) + "&nbsp;";
    
    message.appendChild(handle);
  }
  
  if(!same && participant && participant.picture) {
    var img = new Image();
    img.src = participant.picture;
    img.width = 32;
    img.height= 32;
    message.appendChild(img);
  }
  
  if(!same && !nobr) message.innerHTML += "<br />";
  
  var date = document.createElement("span");
  date.className = "date";
  date.innerHTML = '<span class="invisible">[ ' + handleText + ' - ' + '</span>' + dateText + '<span class="invisible"> ]:&nbsp;</span>';
  
  message.appendChild(date);
  
//if(!same && !nobr) message.innerHTML += "<br />";
  
  var content = document.createElement("span");
  content.className = "content";
  content.innerHTML = messageText;
  
  if(nobr) {
    content.innerHTML = '<span class="invisible">* ' + handleText + '&nbsp;</span>' + content.innerHTML;
    content.style.display = "inline";
  }
  
  message.appendChild(content);
  
  if(first) {
    message.style.border = "none";
    first = false;
  }
  
  var messages = document.getElementById("messages");
  messages.appendChild(message);
  messages.scrollTop = messages.scrollHeight;
  
  return content;
}

function getTimeString(date) {
  if(!date) date = new Date();
  var t = function(s) { return s < 10 ? "0" + s : s; };
  return t(date.getHours()) + ":" + t(date.getMinutes()) + ":" + t(date.getSeconds());
}

var bold = false, italic = false, underline = false;
function checkForEnter(e) {
  if(e.ctrlKey || e.metaKey) {
    var key = String.fromCharCode(e.charCode);
    
    if(this.selectionStart < this.selectionEnd) {
      var start = this.selectionStart;
      var end = this.selectionEnd;
      
      switch(key) {
        case "b":
        case "i":
        case "u":
          this.value = this.value.substring(0, start) + "[" + key + "]" +
                       this.value.substring(start, end) + "[/" + key + "]" +
                       this.value.substring(end); break;
          this.selectionStart = start + 3;
          this.selectionEnd = end + 3;
          this.focus();
        default: return true;
      }
    } else {
      switch(key) {
        case "b": this.value += bold ? "[/b]" : "[b]"; bold = !bold; break;
        case "i": this.value += italic ? "[/i]" : "[i]"; italic = !italic; break;
        case "u": this.value += underline ? "[/u]" : "[u]"; underline = !underline; break;
        
        case "n": this.value += "[br]"; break;
        case " ": this.value += "[nbsp]"; break;
        
        default: return true;
      }
    }
    /*
    if(this.value.length < 8192) {
      var ds = ["[i][/i]", "[b][/b]", "[u][/u]", "[/i][i]", "[/b][b]", "[/u][u]"];
      for(var i = 0; i < ds.length; ++i) this.value = this.value.split(ds[i]).join("");
    }
    */
    
    return false;
  }
  
  if(e.which != 13 || e.altKey) return;
  if(this.value == '') return;
  
  if(bold) this.value += "[/b]";
  if(italic) this.value += "[/i]";
  if(underline) this.value += "[/u]";
  
  if(this.value[0] == '/') { // Seems like we have a command here ;D
    var command = this.value.split(' ')[0].toLowerCase();
    var data = this.value.substring(command.length + 1);
    command = command.substring(1);
    if(handleCommand(command, data)) return;
  } else ExAPI.push({ cmd:'chat', text:this.value });
  
  this.value = "";
  
  if(bold) this.value += "[b]";
  if(italic) this.value += "[i]";
  if(underline) this.value += "[u]";
}

function handleCommand(command, data) {
  switch(command) {
    case 'topic': ExAPI.data('topic', data); break;
    case 'motd': ExAPI.data('motd', data); break;
    case 'dirty': ExAPI.dirty(true); break;
    case 'notify': ExAPI.notify({ body:ExAPI.client.username + ' posted /notify' }); break;
    case 'king': ExAPI.data('king', data); break;
    case 'clear': document.getElementById("messages").innerHTML = ""; first = true; lastHandle = ""; break;
    case 'me': ExAPI.push({ cmd:'me', text:data }); break; // What about "/me&paul&lorenzo rofl" and what about "/me,", "/me!" ?! [TODO]!!!
    case 'google': top.location.href = "http://www.google.com/search?q=" + data; break; // wtf...?
    case 'drop': ExAPI.drop(data); break;
    default: {
      alert('There is no such command "/' + command + '"');
    }; return true;
  } return false;
}

function zoom(img, e) {
  if(img.className) {
    img.className = "";
    img.onmousemove = function(e) {
      var w = window.innerWidth - 6;
      var r = (e.pageX - 6) / w;
      img.style.left = Math.round(-(img.width - w) * r) + "px";
    };
    img.onmousemove(e);
  } else {
    img.className = "unzoom";
    img.onmousemove = undefined;
    img.style.left = "";
  }
}

function encode(str) {
  var res = "";
  for(var i = 0; i < str.length; ++i) res += "&#" + str.charCodeAt(i) + ";";
  return res;
}